"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __values = (this && this.__values) || function(o) {
    var s = typeof Symbol === "function" && Symbol.iterator, m = s && o[s], i = 0;
    if (m) return m.call(o);
    if (o && typeof o.length === "number") return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
    throw new TypeError(s ? "Object is not iterable." : "Symbol.iterator is not defined.");
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.detectBrowsers = exports.detectBrowser = exports.getInstallationPath = exports.findBrowserRegistries = exports.findVersion = void 0;
var child_process_1 = require("child_process");
var MAIN_BROWSER_REG = 'HKEY_LOCAL_MACHINE\\SOFTWARE\\WOW6432Node\\Clients\\StartMenuInternet';
var REG_TYPE = 'REG_SZ';
var extractName = function (str) {
    return str.split('\\').slice(-1)[0] || '';
};
var extractPathFromRegistry = function (str) {
    if (!str) {
        return '';
    }
    var path = str.trim().split(REG_TYPE)[1].replace(/\t+/g, '').split(',');
    return path[0].trim();
};
var getSubRegistries = function (data, parentRegistry) {
    if (!data || !parentRegistry) {
        return [];
    }
    return data
        .trim()
        .split('\r\n')
        .filter(function (s) { return s.length > parentRegistry.length; });
};
var findVersion = function (browserPath) {
    browserPath = browserPath.replace(/\\/g, '\\\\');
    var command = "wmic datafile where name=\"".concat(browserPath, "\" get Version /value");
    return new Promise(function (resolve, reject) {
        (0, child_process_1.exec)(command, function (err, stdout, stderr) {
            if (stderr || err) {
                reject(err);
            }
            else {
                if (stdout) {
                    var version = stdout.trim().replace('Version=', '');
                    resolve(version);
                }
                else {
                    resolve('');
                }
            }
        });
    });
};
exports.findVersion = findVersion;
var findBrowserRegistries = function (mainRegistryPath) {
    return new Promise(function (resolve, reject) {
        var command = "reg query ".concat(mainRegistryPath);
        (0, child_process_1.exec)(command, function (error, stdout, _stderr) {
            if (error) {
                reject(error);
            }
            if (stdout) {
                var subPaths = getSubRegistries(stdout, mainRegistryPath);
                resolve(subPaths);
            }
            else {
                reject();
            }
        });
    });
};
exports.findBrowserRegistries = findBrowserRegistries;
var getInstallationPath = function (browserRegistry) {
    return new Promise(function (resolve, reject) {
        var fullPath = "\"".concat(browserRegistry, "\\DefaultIcon\"");
        (0, child_process_1.exec)("reg query ".concat(fullPath), function (error, stdout, _stderr) {
            if (error) {
                reject(error);
            }
            else {
                var browser = {
                    name: extractName(browserRegistry),
                    path: extractPathFromRegistry(stdout),
                };
                if (browser.name && browser.path) {
                    resolve(browser);
                }
                else {
                    resolve(null);
                }
            }
        });
    });
};
exports.getInstallationPath = getInstallationPath;
//it turns out the registry name for some browsers are diffrent on windows e.g. 'IEXPLORE.EXE', 'Firefox-308046B0AF4A39CB', 'Brave'
var toConsistentName = function (registryName) {
    var name = registryName.toLocaleLowerCase();
    if (name.includes('brave')) {
        return 'Brave Browser';
    }
    if (name.includes('firefox')) {
        return 'Firefox';
    }
    if (name.includes('iexplore')) {
        return 'Internet Explorer';
    }
    return registryName;
};
var detectBrowser = function (browserRegistry) { return __awaiter(void 0, void 0, void 0, function () {
    var browser, version, name;
    return __generator(this, function (_a) {
        switch (_a.label) {
            case 0: return [4 /*yield*/, (0, exports.getInstallationPath)(browserRegistry)];
            case 1:
                browser = _a.sent();
                if (browser == null || !browser.path) {
                    return [2 /*return*/, null];
                }
                return [4 /*yield*/, (0, exports.findVersion)(browser.path)];
            case 2:
                version = _a.sent();
                name = toConsistentName(browser.name);
                return [2 /*return*/, {
                        path: browser.path,
                        version: version,
                        name: name,
                    }];
        }
    });
}); };
exports.detectBrowser = detectBrowser;
var detectBrowsers = function (browserRegistries) { return __awaiter(void 0, void 0, void 0, function () {
    var promises, browserRegistries_1, browserRegistries_1_1, browserRegistry, browsers, detectedBrowsers, browsers_1, browsers_1_1, browser;
    var e_1, _a, e_2, _b;
    return __generator(this, function (_c) {
        switch (_c.label) {
            case 0:
                promises = [];
                try {
                    for (browserRegistries_1 = __values(browserRegistries), browserRegistries_1_1 = browserRegistries_1.next(); !browserRegistries_1_1.done; browserRegistries_1_1 = browserRegistries_1.next()) {
                        browserRegistry = browserRegistries_1_1.value;
                        promises.push((0, exports.detectBrowser)(browserRegistry));
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (browserRegistries_1_1 && !browserRegistries_1_1.done && (_a = browserRegistries_1.return)) _a.call(browserRegistries_1);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
                return [4 /*yield*/, Promise.allSettled(promises)];
            case 1:
                browsers = _c.sent();
                detectedBrowsers = [];
                try {
                    for (browsers_1 = __values(browsers), browsers_1_1 = browsers_1.next(); !browsers_1_1.done; browsers_1_1 = browsers_1.next()) {
                        browser = browsers_1_1.value;
                        if (browser.status === 'fulfilled' && browser.value != null) {
                            detectedBrowsers.push(browser.value);
                        }
                    }
                }
                catch (e_2_1) { e_2 = { error: e_2_1 }; }
                finally {
                    try {
                        if (browsers_1_1 && !browsers_1_1.done && (_b = browsers_1.return)) _b.call(browsers_1);
                    }
                    finally { if (e_2) throw e_2.error; }
                }
                return [2 /*return*/, detectedBrowsers];
        }
    });
}); };
exports.detectBrowsers = detectBrowsers;
function detectWinInstalledBrowsers(browserNames) {
    return __awaiter(this, void 0, void 0, function () {
        var browserRegistries, detectedBrowsers;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0: return [4 /*yield*/, (0, exports.findBrowserRegistries)(MAIN_BROWSER_REG)];
                case 1:
                    browserRegistries = _a.sent();
                    return [4 /*yield*/, (0, exports.detectBrowsers)(browserRegistries)
                        //return only defined browsers
                    ];
                case 2:
                    detectedBrowsers = _a.sent();
                    //return only defined browsers
                    return [2 /*return*/, detectedBrowsers.filter(function (b) { return browserNames.includes(b.name); })];
            }
        });
    });
}
exports.default = detectWinInstalledBrowsers;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV0ZWN0LXdpbi1icm93c2Vycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9lcHMvbWFpbi9jb21wb25lbnRzL2Jyb3dzZXItZGV0ZWN0b3IvZGV0ZWN0LXdpbi1icm93c2Vycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLCtDQUFtRDtBQUduRCxJQUFNLGdCQUFnQixHQUFHLHVFQUF1RSxDQUFBO0FBRWhHLElBQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQTtBQUV6QixJQUFNLFdBQVcsR0FBRyxVQUFDLEdBQVc7SUFDOUIsT0FBTyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQTtBQUMzQyxDQUFDLENBQUE7QUFFRCxJQUFNLHVCQUF1QixHQUFHLFVBQUMsR0FBVztJQUMxQyxJQUFJLENBQUMsR0FBRyxFQUFFO1FBQ1IsT0FBTyxFQUFFLENBQUE7S0FDVjtJQUNELElBQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDekUsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUE7QUFDdkIsQ0FBQyxDQUFBO0FBRUQsSUFBTSxnQkFBZ0IsR0FBRyxVQUFDLElBQWEsRUFBRSxjQUF1QjtJQUM5RCxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFO1FBQzVCLE9BQU8sRUFBRSxDQUFBO0tBQ1Y7SUFDRCxPQUFPLElBQUk7U0FDUixJQUFJLEVBQUU7U0FDTixLQUFLLENB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